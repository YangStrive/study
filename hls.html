<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>M3U8 è§†é¢‘æ’­æ”¾å™¨</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 2.5em;
        font-weight: 300;
      }

      .content {
        padding: 30px;
      }

      .control-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .input-group input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      video {
        width: 100%;
        height: auto;
        display: block;
      }

      .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 500;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #cce7ff;
        color: #004085;
        border: 1px solid #b8daff;
      }

      .demo-urls {
        margin-top: 20px;
      }

      .demo-urls h3 {
        margin-bottom: 10px;
        color: #667eea;
      }

      .demo-url {
        display: block;
        margin: 5px 0;
        padding: 8px 12px;
        background: #e9ecef;
        border-radius: 5px;
        text-decoration: none;
        color: #495057;
        cursor: pointer;
        transition: background 0.2s;
      }

      .demo-url:hover {
        background: #dee2e6;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .debug-info {
        margin-top: 10px;
        padding: 10px;
        background: #1a1a1a;
        color: #00ff00;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #333;
      }

      .tips {
        margin-top: 20px;
        padding: 15px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        color: #856404;
      }

      .tips h4 {
        margin-top: 0;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¬ M3U8 è§†é¢‘æ’­æ”¾å™¨</h1>
        <p>åŸºäº HLS.js çš„ç°ä»£åŒ–è§†é¢‘æ’­æ”¾è§£å†³æ–¹æ¡ˆ</p>
      </div>

      <div class="content">
        <div class="control-panel">
          <div class="input-group">
            <input
              type="url"
              id="urlInput"
              placeholder="è¯·è¾“å…¥ M3U8 è§†é¢‘é“¾æ¥..."
            />
            <button class="btn" onclick="loadVideo()">æ’­æ”¾è§†é¢‘</button>
          </div>

          <div class="demo-urls">
            <h3>ğŸ“º ç¤ºä¾‹è§†é¢‘é“¾æ¥</h3>
            <a
              class="demo-url"
              onclick="loadDemoUrl(this)"
              data-url="https://record-api.huohua.cn/content/CR250724948518/stream/teacher/desktop.m3u8"
            >
              ğŸ¯ ä½ çš„æµ‹è¯•è§†é¢‘ - ä¸è¿ç»­æµ
            </a>
            <a
              class="demo-url"
              onclick="loadDemoUrl(this)"
              data-url="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"
            >
              Big Buck Bunny - æµ‹è¯•è§†é¢‘
            </a>
            <a
              class="demo-url"
              onclick="loadDemoUrl(this)"
              data-url="https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8"
            >
              Sintel - å¼€æºåŠ¨ç”»ç”µå½±
            </a>
            <a
              class="demo-url"
              onclick="loadDemoUrl(this)"
              data-url="https://multiplatform-f.akamaihd.net/i/multi/will/bunny/big_buck_bunny_,640x360_400,640x360_700,640x360_1000,950x540_1500,.f4v.csmil/master.m3u8"
            >
              Big Buck Bunny - å¤šç ç‡è‡ªé€‚åº”
            </a>
            <a
              class="demo-url"
              onclick="loadDemoUrl(this)"
              data-url="./vid.m3u8"
              >333</a
            >
          </div>
        </div>

        <div class="video-container">
          <video id="videoPlayer" controls muted>
            <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚</p>
          </video>
          <div id="loading" class="loading hidden">æ­£åœ¨åŠ è½½è§†é¢‘...</div>
        </div>

        <div id="status" class="status hidden"></div>

        <div class="tips">
          <h4>ğŸ’¡ æ’­æ”¾æç¤º</h4>
          <p><strong>é’ˆå¯¹ä¸è¿ç»­æµè§†é¢‘ï¼ˆå¦‚ä½ çš„æµ‹è¯•è§†é¢‘ï¼‰ï¼š</strong></p>
          <ul>
            <li>å¦‚æœé‡åˆ° "bufferAppendingError" é”™è¯¯ï¼Œæ’­æ”¾å™¨ä¼šè‡ªåŠ¨å°è¯•ä¿®å¤</li>
            <li>ä¸è¿ç»­æµå¯èƒ½åœ¨åˆ†æ®µåˆ‡æ¢æ—¶æœ‰çŸ­æš‚åœé¡¿ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡</li>
            <li>å»ºè®®ä½¿ç”¨ Chrome æˆ– Firefox æµè§ˆå™¨ä»¥è·å¾—æœ€ä½³ä½“éªŒ</li>
            <li>å¦‚æœæ’­æ”¾å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰è·å–è¯¦ç»†è°ƒè¯•ä¿¡æ¯</li>
          </ul>
          <p><strong>è°ƒè¯•æŠ€å·§ï¼š</strong></p>
          <ul>
            <li>æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</li>
            <li>æ’­æ”¾è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨è¾“å‡ºè°ƒè¯•ä¿¡æ¯åˆ°æ§åˆ¶å°</li>
            <li>æ”¯æŒå¤šç§é”™è¯¯è‡ªåŠ¨æ¢å¤æœºåˆ¶</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- å¼•å…¥æœ€æ–°çš„ HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.6.7"></script>

    <script>
      let hls = null;
      const video = document.getElementById("videoPlayer");
      const urlInput = document.getElementById("urlInput");
      const statusDiv = document.getElementById("status");
      const loadingDiv = document.getElementById("loading");

      // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      function showStatus(message, type = "info") {
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.classList.remove("hidden");

        if (type === "success") {
          setTimeout(() => {
            statusDiv.classList.add("hidden");
          }, 3000);
        }
      }

      // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
      function showLoading(show) {
        if (show) {
          loadingDiv.classList.remove("hidden");
        } else {
          loadingDiv.classList.add("hidden");
        }
      }

      // åŠ è½½è§†é¢‘
      function loadVideo() {
        const url = urlInput.value.trim();

        if (!url) {
          showStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„ M3U8 è§†é¢‘é“¾æ¥", "error");
          return;
        }

        // éªŒè¯URLæ ¼å¼
        if (!isValidM3U8Url(url)) {
          showStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„ M3U8 æ ¼å¼è§†é¢‘é“¾æ¥", "error");
          return;
        }

        showLoading(true);
        showStatus("æ­£åœ¨åŠ è½½è§†é¢‘...", "info");

        // æ¸…ç†ä¹‹å‰çš„ HLS å®ä¾‹
        if (hls) {
          hls.destroy();
        }

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if (Hls.isSupported()) {
          hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: false, // å…³é—­ä½å»¶è¿Ÿæ¨¡å¼ï¼Œæé«˜å…¼å®¹æ€§
            backBufferLength: 90,
            // é’ˆå¯¹ä¸è¿ç»­æµçš„é…ç½®ä¼˜åŒ–
            maxBufferLength: 30,
            maxBufferSize: 60 * 1000 * 1000, // 60MB
            maxBufferHole: 0.3,
            highBufferWatchdogPeriod: 3,
            // åˆ†æ®µåŠ è½½é…ç½®
            maxLoadingDelay: 4,
            maxFragLookUpTolerance: 0.25,
            // é”™è¯¯é‡è¯•é…ç½®
            fragLoadingTimeOut: 20000,
            fragLoadingMaxRetry: 6,
            fragLoadingRetryDelay: 1000,
            // åª’ä½“æºé…ç½®
            appendErrorMaxRetry: 3,
            // å…³é”®ï¼šå¯ç”¨æ›´å®½æ¾çš„åˆ†æ®µå¤„ç†
            enableSoftwareAES: true,
            // é’ˆå¯¹ä¸è¿ç»­æµçš„ç‰¹æ®Šé…ç½®
            forceKeyFrameOnDiscontinuity: true,
          });

          hls.loadSource(url);
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, function () {
            showLoading(false);
            showStatus("è§†é¢‘åŠ è½½æˆåŠŸï¼", "success");
            console.log("è§†é¢‘æ¸…æ™°åº¦é€‰é¡¹:", hls.levels);
          });

          // æ·»åŠ æ›´å¤šæœ‰ç”¨çš„äº‹ä»¶ç›‘å¬
          hls.on(Hls.Events.FRAG_LOADING, function (event, data) {
            console.log("æ­£åœ¨åŠ è½½åˆ†æ®µ:", data.frag.url);
          });

          hls.on(Hls.Events.FRAG_LOADED, function (event, data) {
            console.log("åˆ†æ®µåŠ è½½å®Œæˆ:", data.frag.url);
          });

          hls.on(Hls.Events.BUFFER_APPENDING, function (event, data) {
            console.log("æ­£åœ¨è¿½åŠ ç¼“å†²åŒºæ•°æ®...");
          });

          hls.on(Hls.Events.BUFFER_APPENDED, function (event, data) {
            console.log("ç¼“å†²åŒºæ•°æ®è¿½åŠ å®Œæˆ");
          });

          hls.on(Hls.Events.BUFFER_EOS, function (event, data) {
            console.log("ç¼“å†²åŒºç»“æŸ");
          });

          // ç›‘å¬ä¸è¿ç»­ç‚¹å¤„ç†
          hls.on(Hls.Events.LEVEL_SWITCHING, function (event, data) {
            console.log("åˆ‡æ¢æ¸…æ™°åº¦:", data.level);
          });

          hls.on(Hls.Events.ERROR, function (event, data) {
            console.error("HLS é”™è¯¯:", data);

            if (data.fatal) {
              showLoading(false);
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  showStatus(
                    "ç½‘ç»œé”™è¯¯ï¼šæ— æ³•åŠ è½½è§†é¢‘ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è§†é¢‘é“¾æ¥",
                    "error"
                  );
                  // å°è¯•é‡æ–°åŠ è½½
                  setTimeout(() => {
                    if (hls) {
                      hls.startLoad();
                    }
                  }, 1000);
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  showStatus("åª’ä½“é”™è¯¯ï¼šæ­£åœ¨å°è¯•æ¢å¤æ’­æ”¾...", "info");
                  // å°è¯•åª’ä½“é”™è¯¯æ¢å¤
                  try {
                    hls.recoverMediaError();
                    showStatus("é”™è¯¯æ¢å¤æˆåŠŸï¼Œç»§ç»­æ’­æ”¾", "success");
                  } catch (e) {
                    showStatus("åª’ä½“é”™è¯¯ï¼šè§†é¢‘æ ¼å¼ä¸å—æ”¯æŒæˆ–æ–‡ä»¶æŸå", "error");
                  }
                  break;
                default:
                  showStatus("æ’­æ”¾é”™è¯¯ï¼š" + data.details, "error");
                  break;
              }
            } else {
              // å¤„ç†éè‡´å‘½é”™è¯¯
              switch (data.details) {
                case "bufferAppendingError":
                  showStatus("ç¼“å†²é”™è¯¯ï¼šæ­£åœ¨å°è¯•ä¿®å¤...", "info");
                  // æ¸…ç†ç¼“å†²åŒºå¹¶é‡è¯•
                  setTimeout(() => {
                    if (hls && video.buffered.length > 0) {
                      try {
                        hls.recoverMediaError();
                        showStatus("ç¼“å†²é”™è¯¯å·²ä¿®å¤", "success");
                      } catch (e) {
                        console.warn("åª’ä½“é”™è¯¯æ¢å¤å¤±è´¥:", e);
                      }
                    }
                  }, 500);
                  break;
                case "bufferSeeking":
                  showStatus("æ­£åœ¨ç¼“å†²...", "info");
                  break;
                case "bufferStalled":
                  showStatus("æ’­æ”¾æš‚åœï¼šæ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®...", "info");
                  break;
                default:
                  console.warn("HLS è­¦å‘Š:", data.details);
                  break;
              }
            }
          });

          // ç›‘å¬æ’­æ”¾çŠ¶æ€
          video.addEventListener("loadstart", () => {
            showStatus("å¼€å§‹åŠ è½½è§†é¢‘...", "info");
          });

          video.addEventListener("canplay", () => {
            showStatus("è§†é¢‘å‡†å¤‡å°±ç»ª", "success");
          });

          video.addEventListener("error", (e) => {
            showLoading(false);
            showStatus("è§†é¢‘æ’­æ”¾é”™è¯¯ï¼š" + e.message, "error");
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // Safari åŸç”Ÿæ”¯æŒ
          video.src = url;
          showLoading(false);
          showStatus("ä½¿ç”¨ Safari åŸç”Ÿæ’­æ”¾å™¨ï¼ˆæ›´å¥½çš„å…¼å®¹æ€§ï¼‰", "success");
        } else {
          // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šå°è¯•ç›´æ¥è®¾ç½®src
          showStatus("æµè§ˆå™¨ä¸æ”¯æŒHLS.jsï¼Œå°è¯•åŸç”Ÿæ’­æ”¾...", "info");
          video.src = url;
          video.addEventListener("loadedmetadata", function () {
            showLoading(false);
            showStatus("ä½¿ç”¨åŸç”Ÿæ’­æ”¾å™¨æˆåŠŸ", "success");
          });
          video.addEventListener("error", function () {
            showLoading(false);
            showStatus(
              "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾ï¼Œå»ºè®®ä½¿ç”¨Chromeæˆ–Firefox",
              "error"
            );
          });
        }
      }

      // éªŒè¯ M3U8 URL
      function isValidM3U8Url(url) {
        try {
          const urlObj = new URL(url);
          return (
            urlObj.pathname.endsWith(".m3u8") ||
            urlObj.pathname.includes(".m3u8") ||
            url.includes("m3u8")
          );
        } catch {
          return false;
        }
      }

      // åŠ è½½ç¤ºä¾‹URL
      function loadDemoUrl(element) {
        const url = element.dataset.url;
        urlInput.value = url;
        loadVideo();
      }

      // å›è½¦é”®å¿«é€Ÿæ’­æ”¾
      urlInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          loadVideo();
        }
      });

      // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
      window.addEventListener("beforeunload", function () {
        if (hls) {
          hls.destroy();
        }
      });

      // åˆå§‹åŒ–æç¤º
      showStatus("è¯·è¾“å…¥ M3U8 è§†é¢‘é“¾æ¥æˆ–é€‰æ‹©ç¤ºä¾‹è§†é¢‘å¼€å§‹æ’­æ”¾", "info");

      // æ·»åŠ è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
      function showDebugInfo() {
        if (hls) {
          console.log("=== HLS æ’­æ”¾å™¨çŠ¶æ€ ===");
          console.log("å½“å‰åŠ è½½çŠ¶æ€:", hls.loadLevel);
          console.log("å¯ç”¨æ¸…æ™°åº¦:", hls.levels);
          console.log("å½“å‰æ’­æ”¾æ¸…æ™°åº¦:", hls.currentLevel);
          console.log("ç¼“å†²åŒºä¿¡æ¯:", {
            buffered: video.buffered,
            currentTime: video.currentTime,
            duration: video.duration,
          });
          console.log("æ’­æ”¾å™¨é…ç½®:", hls.config);
          console.log("====================");
        }
      }

      // æ¯5ç§’è¾“å‡ºä¸€æ¬¡è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨æ§åˆ¶å°å¯è§ï¼‰
      setInterval(showDebugInfo, 5000);

      // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
      document.addEventListener("keydown", function (e) {
        if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I")) {
          // å½“å¼€å‘è€…å·¥å…·æ‰“å¼€æ—¶ï¼Œæ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯
          setTimeout(showDebugInfo, 500);
        }
      });
    </script>
  </body>
</html>
